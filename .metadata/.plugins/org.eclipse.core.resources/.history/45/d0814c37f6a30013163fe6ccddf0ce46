package com.sp.mall.fragments;


import java.util.ArrayList;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.support.v4.app.Fragment;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.ImageButton;
import android.widget.ListView;

import com.android.volley.Request;
import com.android.volley.RequestQueue;
import com.android.volley.Response;
import com.android.volley.toolbox.JsonObjectRequest;
import com.android.volley.toolbox.Volley;
import com.sp.mall.R;
import com.sp.mall.data.Comment;
import com.sp.mall.data.Helper;
import com.sp.mall.data.ImageAdapter;
import com.sp.mall.data.Photo;

public class ComunityFragment extends Fragment { 
	private static final int LOAD_IMAGE =1;
	private static final int CAMERA = 2;
	ImageButton btnFromCamera;
	ImageAdapter adapter=null;
	View view;
	ListView list;
	PhotoDialogFragment dialog;
	ArrayList<Photo> imagesArray;
	public static RequestQueue requestQueue;
	public View onCreateView(LayoutInflater inflater, ViewGroup container, 
	        Bundle savedInstanceState) { 
			requestQueue = Volley.newRequestQueue(getActivity());
	        view = inflater.inflate(R.layout.comunity_fragment,container, false);
	        list = (ListView) view.findViewById(R.id.listViewP);
	        imagesArray = new ArrayList<Photo>();
	        adapter = new ImageAdapter(getActivity(),imagesArray);
	        list.setAdapter(adapter);
	        btnFromCamera = (ImageButton) view.findViewById(R.id.btnFromCamera);
	        dialog = new PhotoDialogFragment();
	        btnFromCamera.setOnClickListener(new OnClickListener() {
				@Override
				public void onClick(View v) {
					AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());
					builder.setTitle("Menu");
					ArrayAdapter<String> adaptador = new ArrayAdapter<String>(getActivity(),android.R.layout.simple_list_item_1);
					adaptador.add("Tomar Fotografia");
					adaptador.add("Desde la galeria");
					builder.setAdapter(adaptador, new DialogInterface.OnClickListener() {
						
						@Override
						public void onClick(DialogInterface dialog, int which) {
							int code = 0;
							Intent intent = null;
							if(which==0){
								 intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
								 code = CAMERA;
							}else if(which==1){
								intent = new Intent(Intent.ACTION_PICK,android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
								code = LOAD_IMAGE;
							}
								startActivityForResult(intent, code);
						}
					});
				builder.create().show();
				}
			});
	        return view;
	}
	
	@Override
	public void onActivityResult(int requestCode, int resultCode, Intent data) {
		super.onActivityResult(requestCode, resultCode, data);
		Bitmap bitmap = null;
		String text = "";
		switch(requestCode){
		case LOAD_IMAGE:
			if (resultCode == getActivity().RESULT_OK){
				bitmap = fromGallery(data);
				text = "Gallery";
			}
			break;
		case CAMERA:
			if (resultCode == getActivity().RESULT_OK){
				bitmap = fromCamera(data);
				text = "Photo";
			}
			break;
			
		}
		adapter.setArrays(bitmap.hashCode(),text,bitmap);
		
	}
	
	private void APICall() {
		// TODO Auto-generated method stub
		String url = Helper.getRecentMediaUrl("guatemala");
		view.findViewById(R.id.progressBar1).setVisibility(View.VISIBLE);
		Response.Listener<JSONObject> listener = new Response.Listener<JSONObject>(){
			@Override
			public void onResponse(JSONObject arg0) {
				// TODO Auto-generated method stub
				view.findViewById(R.id.progressBar1).setVisibility(View.GONE);
				list = (ListView) view.findViewById(R.id.listViewP);
				list.setVisibility(view.VISIBLE);
				JSONArray data;
				try{
					data = arg0.getJSONArray("data");
					for(int i =0;i<data.length();i++){
						JSONObject element = data.getJSONObject(i);
						String type = element.getString("type");
						if(type.equals("image")){
							JSONObject user = element.getJSONObject("user");
							JSONObject images = element.getJSONObject("images");
							JSONObject standardResolution = images.getJSONObject("standard_resolution");
							String userName = user.getString("username");
							String imgUrl = standardResolution.getString("url");
							ArrayList<Comment> test = new ArrayList<Comment>();
							test.add(new Comment("hola"));
							Photo image = new Photo(imgUrl,"holas",test,"20");
							imagesArray.add(image);
						}
					}
					adapter.notifyDataSetChanged();
				}catch(JSONException e){
					Log.e("ERROR", Log.getStackTraceString(e));
				}
				Log.e("Respuesta ", arg0.toString());
				
			}};
		JsonObjectRequest request = new JsonObjectRequest(Request.Method.GET, url,null, listener, null);
		requestQueue.add(request);
	}
	public Bitmap fromGallery(Intent data){
		Bitmap bitmap=null;
		if(data != null){
			Uri selectedImage = data.getData();
			String[] filePathColumn = {MediaStore.Images.Media.DATA};
			Cursor cursor =getActivity().getContentResolver().query(selectedImage,filePathColumn,null,null,null);
			if(cursor.moveToFirst()){
				int columnIndex = cursor.getColumnIndex(filePathColumn[0]);
				String picturePath = cursor.getString(columnIndex);
				cursor.close();	
				 bitmap = BitmapFactory.decodeFile(picturePath);		
				//ImageView img = (ImageView)view.findViewById(R.id.imageView1);	
				//img.setImageBitmap(bit);
				
				
			}
		}
		return bitmap;
	}
	public Bitmap fromCamera(Intent data){
		Bitmap bitmap=null;
		Bundle extras = data.getExtras();
		if(extras != null ){
			 bitmap = (Bitmap) extras.get("data");
		}
		return bitmap;
	}
		
}

